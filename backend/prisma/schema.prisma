// Prisma Schema for Stappa App
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users Table
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  role      Role     @default(USER)
  status    Status   @default(ACTIVE)
  firstName String?
  lastName  String?
  phone     String?
  birthdate DateTime? // Age verification (required for alcohol content compliance)
  city      String?
  province  String?
  region    String?
  
  // Preferences
  favoriteEstablishments String[] @default([])
  canPostSocial          Boolean  @default(false)
  isSocialManager        Boolean  @default(false)
  canManageStock         Boolean  @default(false) // Can manage inventory
  
  // Relations
  establishmentId String?
  establishment   Establishment? @relation(fields: [establishmentId], references: [id])
  
  progress        UserProgress[]
  validations     Validation[]
  merchantRequests MerchantRequest[]
  bugReports      BugReport[]
  qrCodes         QRCode[]
  reviews         Review[]
  socialPosts     SocialPost[]
  stockPhotos     StockPhoto[]
  stockEntries    StockEntry[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([username])
  @@index([email])
  @@index([role])
  @@index([establishmentId])
}

// Establishments Table
model Establishment {
  id       String  @id @default(uuid())
  name     String
  address  String
  city     String?
  province String?
  region   String?
  latitude Float?
  longitude Float?
  status   Status  @default(ACTIVE)
  
  // Feature flags
  hasStockManagement Boolean @default(false)
  
  // Relations
  merchants   User[]
  promos      Promo[]
  progress    UserProgress[]
  validations Validation[]
  reviews     Review[]
  schedules   Schedule[]
  socialPosts SocialPost[]
  articles    Article[]
  stockPhotos StockPhoto[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([city])
  @@index([status])
}

// Promos Table
model Promo {
  id              String   @id @default(uuid())
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  ticketCost      Int
  ticketsRequired Int
  rewardValue     Float
  description     String?
  
  startDate  DateTime
  endDate    DateTime
  expiresAt  DateTime
  isActive   Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([establishmentId])
  @@index([isActive])
  @@index([endDate])
}

// User Progress Table
model UserProgress {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  drinksCount Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, establishmentId])
  @@index([userId])
  @@index([establishmentId])
}

// QR Codes Table
model QRCode {
  id              String   @id @default(uuid())
  token           String   @unique
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishmentId String
  type            QRType
  expiresAt       DateTime
  isUsed          Boolean  @default(false)
  usedAt          DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Validations Table
model Validation {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  type            QRType
  merchantId      String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([establishmentId])
  @@index([createdAt])
}

// Merchant Requests Table
model MerchantRequest {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  businessName   String
  address        String
  city           String
  postalCode     String
  country        String
  vatId          String
  phone          String
  description    String?
  
  status         RequestStatus @default(PENDING)
  reviewedAt     DateTime?
  reviewedBy     String?
  rejectionReason String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
}

// Bug Reports Table
model BugReport {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  category    String
  screenshots String[] @default([])
  
  status      BugStatus @default(OPEN)
  priority    Priority  @default(MEDIUM)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([priority])
}

// Reviews Table
model Review {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  rating          Int      // 1-5 stars
  comment         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, establishmentId])
  @@index([userId])
  @@index([establishmentId])
  @@index([rating])
}

// Schedule Table (Opening hours)
model Schedule {
  id              String   @id @default(uuid())
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  dayOfWeek       Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  openTime        String   // "09:00"
  closeTime       String   // "23:00"
  isClosed        Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([establishmentId, dayOfWeek])
  @@index([establishmentId])
}

// Social Posts Table
model SocialPost {
  id              String   @id @default(uuid())
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  authorId        String
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  type            PostType @default(POST)
  content         String
  imageUrl        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([establishmentId])
  @@index([authorId])
  @@index([createdAt])
}

// Localities Table
model Locality {
  id        String   @id @default(uuid())
  name      String
  postalCode String
  province  String
  region    String

  @@index([name])
  @@index([postalCode])
}

// Enums
enum Role {
  USER
  MERCHANT
  SENIOR_MERCHANT
  ROOT
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum QRType {
  VALIDATION
  BONUS
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BugStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum PostType {
  POST
  STORY
}

enum ArticleCategory {
  BEER
  WINE
  SPIRITS
  COCKTAIL
  SOFT_DRINK
  FOOD
  OTHER
}

enum RecognitionStatus {
  PENDING      // Waiting for merchant confirmation
  CONFIRMED    // Merchant confirmed
  REJECTED     // Merchant rejected
  MODIFIED     // Merchant modified quantity or article
}

// Articles (Products) - Each establishment has its own catalog
model Article {
  id              String          @id @default(uuid())
  establishmentId String
  establishment   Establishment   @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  name            String          // e.g., "Heineken 33cl"
  category        ArticleCategory @default(BEER)
  brand           String?         // e.g., "Heineken"
  size            String?         // e.g., "33cl", "75cl"
  description     String?
  barcode         String?         // EAN/UPC code if available
  imageUrl        String?         // Reference image of the bottle/product
  
  // Inventory
  currentStock    Int             @default(0)
  minStock        Int             @default(0) // Alert threshold
  
  // AI Recognition data
  visualFeatures  Json?           // Store AI features for recognition (colors, shape, label text)
  
  stockEntries    StockEntry[]
  recognitions    ArticleRecognition[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([establishmentId, name])
  @@index([establishmentId])
  @@index([category])
  @@index([barcode])
}

// Stock Entries - Track inventory changes
model StockEntry {
  id              String    @id @default(uuid())
  establishmentId String    // Denormalized for faster queries
  articleId       String
  article         Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  quantity        Int       // Positive = added, Negative = removed
  type            String    // "manual", "photo_ai", "sale", "waste"
  notes           String?
  
  userId          String    // Who made the change
  user            User      @relation(fields: [userId], references: [id])
  
  stockPhotoId    String?   // If from AI photo
  stockPhoto      StockPhoto? @relation(fields: [stockPhotoId], references: [id])
  
  createdAt       DateTime  @default(now())
  
  @@index([articleId])
  @@index([establishmentId])
  @@index([userId])
  @@index([createdAt])
}

// Stock Photos - Photos taken for AI analysis
model StockPhoto {
  id              String    @id @default(uuid())
  establishmentId String
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  userId          String    // Who took the photo
  user            User      @relation(fields: [userId], references: [id])
  
  imageUrl        String    // S3/cloud storage URL
  status          RecognitionStatus @default(PENDING)
  
  // AI Analysis results
  totalItemsDetected Int     @default(0)
  aiAnalysisData     Json?   // Raw AI response
  
  recognitions    ArticleRecognition[]
  stockEntries    StockEntry[]
  
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([establishmentId])
  @@index([userId])
  @@index([status])
}

// Article Recognition - Individual bottle/item detected in photo
model ArticleRecognition {
  id            String    @id @default(uuid())
  stockPhotoId  String
  stockPhoto    StockPhoto @relation(fields: [stockPhotoId], references: [id], onDelete: Cascade)
  
  articleId     String?   // Matched article (null if new/unknown)
  article       Article?  @relation(fields: [articleId], references: [id])
  
  detectedName  String?   // AI detected product name
  detectedBrand String?   // AI detected brand
  confidence    Float     @default(0) // 0-1 confidence score
  quantity      Int       @default(1) // How many of this item detected
  
  status        RecognitionStatus @default(PENDING)
  boundingBox   Json?     // Position in image {x, y, width, height}
  
  // Merchant corrections
  correctedArticleId String?
  correctedQuantity  Int?
  merchantNotes      String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([stockPhotoId])
  @@index([articleId])
  @@index([status])
}
